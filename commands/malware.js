const Discord = require('discord.js')
const { Client, Intents } = require('discord.js');
const client = new Client({ 
    intents: [
        Intents.FLAGS.GUILDS,
        Intents.FLAGS.GUILD_MEMBERS,
        Intents.FLAGS.GUILD_INVITES,
        Intents.FLAGS.GUILD_PRESENCES,
        Intents.FLAGS.GUILD_MESSAGES,
        Intents.FLAGS.DIRECT_MESSAGES,
    ]
});

const list = require("./list");
const allowlist = require("./allowlist");

module.exports ={
    malware: async function(message,client,guildConf){  
        const messa = message.content.toLowerCase(); 
        if(messa.includes("https://")||messa.includes("http://")){
            let banned = list.arr;
            let allow = allowlist.arr;
    
            // Some sort of worm has been spread which uses messages like this to spread.
            const malregex = /(creator|publisher).+(enter|participate).+(beta|closed beta).+(bonus|reward).+(download|install).+(link|file)/i
            const malregex2 = /(steam|csgo).+(giveaway|giving away|leaving).+(nitro|closed beta|trades)/i
            const strx = messa;
            let mal;
            var url = messa.match(/\bhttps?:\/\/\S+/gi);
    
            for (var i = 0; i < url.length; i++) { //checks all links
                for (var l = 0; l < allow.length; l++) { //real links
                    if (url[i].includes(allow[l])) {
                        return;
                    }
                    else{
                        for (var x = 0; x < banned.length; x++) { //fake link
                            if (url[i].includes(banned[x])) {
                                trigger(message,client,guildConf);
                                return;
                            }
                        }
                        if((mal = malregex2.exec(strx)) !== null){ //if missed fake link
                            trigger(message,client,guildConf);
                            return;
                        }
                    }   
                }
            }
        }
    }
}

const trigger  = async (message,client,guildConf) => {
    message.channel.send("<@"+message.author.id+">, account might be compromised.");
    message.author.send("We noticed you've been compromised by self-spreading malware (a worm) which takes over your account to send download links to this worm to others.\nYou must run a Windows Defender full scan and change your password.")
    .catch(console.error);
    //console.log(guildConf.logchannel)
    //logging
    if(guildConf.logchannel.includes("#")){
        const channelid = guildConf.logchannel.split("#")[1].slice(0,-1)    
        console.log(channelid)
        console.log(guildConf.logchannel)
        const channel = client.channels.cache.find(channel => channel.id === channelid);
        let time = message.createdTimestamp
        var date = new Date(time * 1000);
        var hours = date.getHours();
        var minutes = "0" + date.getMinutes();
        var seconds = "0" + date.getSeconds();
        var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
        console.log(formattedTime);
    
        const embed = new Discord.MessageEmbed()
        .setTitle('A user may be compromised')
        .setAuthor('Anti malware', 'https://cdn.discordapp.com/attachments/489898965282848778/879029494168571904/anti-malware-icon-28.png')
        .setColor(0xFF0000)
        .setDescription(message.content)
        .addField('person id', message.author.id)
        .addField("person name ", message.author.tag)
        .setFooter("today at "+formattedTime)
        channel.send({ embeds: [embed] });
    }
    message.delete();
}