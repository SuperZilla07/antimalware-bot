const Discord = require('discord.js')
const { Client, Intents } = require('discord.js');
const client = new Client({ 
    intents: [
        Intents.FLAGS.GUILDS,
        Intents.FLAGS.GUILD_MEMBERS,
        Intents.FLAGS.GUILD_INVITES,
        Intents.FLAGS.GUILD_PRESENCES,
        Intents.FLAGS.GUILD_MESSAGES,
        Intents.FLAGS.DIRECT_MESSAGES,
    ],
    partials:[
        `CHANNEL`,
        `MESSAGE`
    ],
    autoReconnect: true,
});

const config = require("./config");
const list = require("./list");

client.on("ready", async () =>{
    console.log(`Logged in as ${client.user.tag}!`);
    client.user.setActivity(`for maleware`, { type: "WATCHING"});

});

client.on('messageCreate', async message => {
    if(message.author.bot) return;

    let domains = list.arr;
    const messa = message.content.toLowerCase();

    // Some sort of worm has been spread which uses messages like this to spread.
    const malregex = /(creator|publisher).+(enter|participate).+(beta|closed beta).+(bonus|reward).+(download|install).+(link|file)/i
    const malregex2 = /(steam|csgo).+(giveaway|giving away|leaving).+(nitro|closed beta|trades)/i
    const strx = messa;
    let mal;
    if (strx.includes("steamcommunity.com")) return;
    if(strx.includes("https://discord.gift/")) return;
    if(messa.includes("https://")||messa.includes("http://")){
        for (var i = 0; i < domains.length; i++) {
            if (message.content.includes(domains[i])) {
                trigger(message,client);
                return;
            }
        }
        if ((mal = malregex.exec(strx)) !== null){
            trigger(message,client);
            return;
        }
        if((mal = malregex2.exec(strx)) !== null){
            trigger(message,client);
            return;
        }
    }

});

client.login(config.BotToken);



const trigger  = async (message,client) => {
    message.channel.send("<@"+message.author.id+">, account might be compromised.");
    message.author.send("We noticed you've been compromised by self-spreading malware (a worm) which takes over your account to send download links to this worm to others.\nYou must run a Windows Defender full scan and change your password.")
    .catch(console.error);
    const channel = client.channels.cache.find(channel => channel.id === "844273354318938174");
    let time = message.createdTimestamp
    var date = new Date(time * 1000);
    var hours = date.getHours();
    var minutes = "0" + date.getMinutes();
    var seconds = "0" + date.getSeconds();
    var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
    console.log(formattedTime);

    const embed = new Discord.MessageEmbed()
    .setTitle('A user may be compromised')
    .setAuthor('Gamers React', 'https://cdn.discordapp.com/emojis/764541981560537110.png?v=1')
    .setColor(0xFF0000)
    .setDescription(message.content)
    .addField('person id', message.author.id)
    .addField("person name ", message.author.tag)
    .setFooter("today at "+formattedTime)
    //channel.send({ embeds: [embed] });
    message.delete()
}